
# Joint Likelihood Mapping (JLIM) 

JLIM is the cross-trait test of shared causal effect described in Chun et al. ([BioRxiv](http://biorxiv.org/content/early/2016/05/12/053165)). JLIM tests whether two traits – main and secondary – are driven by shared causal effect or not. Typically, the main trait is a large GWAS study, and secondary trait can be an expression Quantitative Trait Loci (eQTL) association study. For main trait, JLIM takes only summary-level association statistics, but for secondary trait, it requires genotype-level data to generate permutation-based null distribution. 

## How to install

The core JLIM module is implemented as an R extension. The installable R module (jlimR) is included in the distribution file. jlimR depends on getopt module, which can be automatically downloaded from CRAN during the installation process. 
 
```
cd jlim-1.0

R CMD INSTALL jlimR_1.0.tar.gz
```

In jlim-1.0/bin, we provide utility scripts to help run jlim on command-line. These files can be placed anywhere. 


## How to run JLIM on provided example  

### Example data
In jlim-1.0/examples, we provide the following dataset: 
- __MS/MS-indexSNP.tsv__ Master file containing the list of index SNPs of known GWAS hits to run JLIM. As an example, we include two GWAS hits and ImmunoChip intervals covering them (chr1:160697074-160933065 and chr12:57626582-58488667). The GWAS hits are originally from IMSGC. Nature Genetics 2013.
- __MS/__ Summary statistics of association to Multiple Sclerosis as primary trait. A separate summary statistic file is provided for each interval listed in the indexSNP file. The data are originally from IMSGC. Nature Genetics 2013. 
- __LCL/__ eQTLs in Lymphoblastoid cell lines (LCL) as secondary trait. A separate directory is provided for each interval listed in the indexSNP file. For each interval, two files are provided for each gene to be analyzed: summary association file (.assoc.linear.gz) and permutation file (.mperm.dump.all.gz) generated by plink. In addition, plink ped file is present (LCL.ped.gz) to calculate in-sample LD matrix. The data are originally from Geuvadis project (Lappalainen et al. Nature 2013). 
- __ld0/__ Reference LD panel for each interval listed in indexSNP file. Data is from the 1000 genomes project phase 3 (release 20130502). 

### Running JLIM on 
Using the indexSNP file, jlim_gencfg.sh scans provided eQTL folder to generate a config file to execute jlim. Then, run_jlim.sh can run on the config file as following:

```
cd jlim-1.0

bin/jlim_gencfg.sh --tr1-name MS --tr1-dir examples/MS --tr2-dir examples/LCL --idxSNP-file examples/MS/MS-indexSNP.tsv --refld-dir examples/ld0/ --out examples/jlim.cfg.tsv 

bin/run_jlim.sh examples/jlim.cfg.tsv 0.8 examples/jlim.out.tsv
```

## File formats
### IndexSNP file 
The indexSNP file is a tab-delimiated file with five columns:
- CHR: chromosome
- SNP: SNP ID of index SNP
- BP: bp position of index SNP
- STARTBP: start of interval around index SNP (bp)
- ENDBP: end of interval around index SNP (bp)

__<CHR>.<STARTBP>.<ENDBP>__ combination will be used to locate primary association statistics, secondary association statistics, and reference LD. In each interval, the most associated SNP will be picked based on primary association data, and the analysis window will be set up to +/- 100kb around the most associated SNP. The JLIM analysis window will not extend over the original interval specificied in the indexSNP file. The exact bp position of index SNP does not matter for JLIM as it will pick the most associated SNP within the specified interval.

### Primary trait summary statistics file
Primary trait file is named by __<TraitName>.<CHR>.<STARTBP>.<ENDBP>.txt__. It is space-delimited and three required columns: CHR, BP, and SNP. It also has to carry one of STAT, T, or P. If P is specified, the two-sided P-value will be transformed into Z-statistic.

### secondary trait files 
Three types of files are required for secondary trait: summary statistics file, permutation file, and genotype file. Summary statistics file is a plink linear assoc file. Permutation file is a plink permutation file. Genotype file is a plink ped-format file for all individuals in the cohort. **Currently, JLIM does not allow missing genotypes for the secondary trait genotype file.** All three files should have an identical set of markers. In case of eQTL, summary statistics and plink permutation files are generated for each genes, but a genotype file is shared for all genes in the interval. The gene-specific files are named as __<TraitName>.<SubID>.assoc.linear.gz__ and __<TraitName>.<SubID>.mperm.dump.all.gz__. The <SubID> can be a gene identifier in case of eQTL. The genoype file is fixed to __<TraitName>.ped.gz__. 

### Reference LD file
Reference LD files are provided one for each interval. It is a tab-delimited file without header. The file name is specified as __locus.<CHR>.<STARTBP>.<ENDBP>.txt.gz__. Each row is a marker, and it contains the following columns: CHROM, POS, ID, REF, ALT, QUAL, FILTER, and followed by two alleles in each individual. 

### Config file
The config file is generated by jlim_gencfg.sh, and contains the following column. JLIM will be executed on each row separately. The config file contains the following columns: 
- maintrID: name of main trait. Specified by --tr1-name.
- chrom: chromosome
- idxSNP: index SNP name (SNP in indexSNP file)
- idxBP: index SNP pos (BP in indexSNP file)
- idxP: P-value of association to primary trait at idxSNP 
- idx2BP: SNP that is most associated to primary trait (automatically selected by JLIM)
- idx2P: P-value of association to primary trait at idx2BP
- start: start of JLIM analysis window
- end: end of JLIM analysis window
- sectrID: name of secondary trait (“LCL” in the above example)
- sectrsubID: sub-identifier of tested association in secondary trait folder (gene names in case of the above example)
- minP2: smallest p-value of association to secondary trait within JLIM analysis window. By default, jlim_gencfg.sh excludes secondary traits with minP2 >= 0.01 from config file. The cut-off can be changed by --p-tr2-cutoff option.    
- maintr: file path to main trait association file
- sectr: file path to secondary trait association file
- refld: file path to reference ld file
- mainld: file path to in-sample ld of main trait cohort if specified (use refld if set to “.”)
- secld: file path to in-sample ld of secondary trait cohort
- perm: permutation file of secondary trait association


### Output file
The JLIM out contains two columns: 
- STAT: JLIM statistic
- p: p-value by permutation. The p-value of 0 means that the JLIM statistic is more extreme than permutation.


## How to run JLIM on your data

1. Specify the indexSNP file.
2. Provide primary trait association file.
3. Generate the reference LD. We provide a sample script to extract LD info for non-Finnish Europeans from downloaded 1000 genomes project vcf files. For example, if the vcf files are present in /net/data/1000genomes/ftp/release/20130502: 

```
bin/fetch.refld0.EUR.pl /net/data/1000genomes/ftp/release/20130502/ examples/MS/MS-indexSNP.tsv examples/ld0/
```
4. Generate secondary trait genotypes (.ped.gz files).
5. Generate secondary trait association and mperm files. For example, 
```
plink --bfile region1 --pheno gene1tx.pheno --linear --out LCL.gene1 --covar yourcov --mperm 1000 --merpm-save-all --chr CHR --from-bp STARTBP --end-bp ENDBP
gzip LCL.gene1.assoc.linear
gzip LCL.gene1.mperm.dump.all 
```
6. Run jlim_gencfg.sh and run_jlim.sh as the above. 

### Parallelize JLIM execution

For parallel execution, JLIM config files can be split into small chunks. The config file does not need column header to be specified unless the column order has not been changed. 

